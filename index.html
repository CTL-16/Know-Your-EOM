<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Know Your EOM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        /* 3D Transform Utilities */
        .perspective-1000 {
            perspective: 1000px;
        }
        .transform-style-3d {
            transform-style: preserve-3d;
        }
        .backface-hidden {
            backface-visibility: hidden;
        }
        .rotate-y-180 {
            transform: rotateY(180deg);
        }
        .preserve-3d {
            transform-style: preserve-3d;
        }
        /* Fade In Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // --- TYPES & CONSTANTS ---

        const MUSCLE_ID = {
            MR: 'MR',
            LR: 'LR',
            SR: 'SR',
            IR: 'IR',
            SO: 'SO',
            IO: 'IO',
        };

        const MUSCLES = [
            { id: MUSCLE_ID.MR, name: "Medial Rectus", actionDescription: "Inward (Adduction)" },
            { id: MUSCLE_ID.LR, name: "Lateral Rectus", actionDescription: "Outward (Abduction)" },
            { id: MUSCLE_ID.SR, name: "Superior Rectus", actionDescription: "Upward (Elevation)" },
            { id: MUSCLE_ID.IR, name: "Inferior Rectus", actionDescription: "Downward (Depression)" },
            { id: MUSCLE_ID.SO, name: "Superior Oblique", actionDescription: "Downward & Outward" },
            { id: MUSCLE_ID.IO, name: "Inferior Oblique", actionDescription: "Upward & Outward" },
        ];

        const INTRO_TEXT = `Welcome to the EOM Laboratory. The Extraocular Muscles (EOM) are a set of six highly specialized muscles that control the movements of the eye.\n\nUnderstanding their primary actions is crucial for diagnosing strabismus and other ocular motility disorders. In this memory game, you will test your knowledge by matching each muscle name to its corresponding animated eye movement.`;

        // --- COMPONENTS ---

        // 1. EyeGraphic Component
        const EyeGraphic = ({ side, muscleId, gaze, scale = 1, showNoseLabel = true }) => {
            const [rotation, setRotation] = useState({ x: 0, y: 0 });

            useEffect(() => {
                if (gaze) {
                    // Learn Mode: Continuous Gaze
                    // x=1 -> Viewer Right. CSS rotateY positive.
                    // x=-1 -> Viewer Left. CSS rotateY negative.
                    // y=1 -> Down. CSS rotateX negative.
                    // y=-1 -> Up. CSS rotateX positive.
                    setRotation({ 
                        x: -gaze.y * 35, 
                        y: gaze.x * 35
                    });
                    return;
                }

                if (!muscleId) {
                    setRotation({ x: 0, y: 0 });
                    return;
                }

                // Game Mode Logic (Discrete Animations)
                let xDeg = 0;
                let yDeg = 0;
                const mag = 30;

                // Right Eye (OD) is on the Viewer's LEFT side of the screen
                if (side === 'right') { 
                    switch (muscleId) {
                        case MUSCLE_ID.MR: yDeg = mag; break; // In (Adduction) -> Viewer Right
                        case MUSCLE_ID.LR: yDeg = -mag; break; // Out (Abduction) -> Viewer Left
                        case MUSCLE_ID.SR: xDeg = mag; break; // Up
                        case MUSCLE_ID.IR: xDeg = -mag; break; // Down
                        case MUSCLE_ID.SO: xDeg = -mag; yDeg = -mag; break; // Down & Out
                        case MUSCLE_ID.IO: xDeg = mag; yDeg = -mag; break; // Up & Out
                    }
                } 
                // Left Eye (OS) is on the Viewer's RIGHT side of the screen
                else { 
                    switch (muscleId) {
                        case MUSCLE_ID.MR: yDeg = -mag; break; // In (Adduction) -> Viewer Left
                        case MUSCLE_ID.LR: yDeg = mag; break; // Out (Abduction) -> Viewer Right
                        case MUSCLE_ID.SR: xDeg = mag; break; // Up
                        case MUSCLE_ID.IR: xDeg = -mag; break; // Down
                        case MUSCLE_ID.SO: xDeg = -mag; yDeg = mag; break; // Down & Out
                        case MUSCLE_ID.IO: xDeg = mag; yDeg = mag; break; // Up & Out
                    }
                }
                setRotation({ x: xDeg, y: yDeg });
            }, [muscleId, side, gaze]);

            return (
                <div className="relative flex items-center justify-center" style={{ transform: `scale(${scale})` }}>
                    {showNoseLabel && (
                        <div className={`absolute top-1/2 -translate-y-1/2 text-[10px] font-bold text-slate-400 uppercase tracking-widest pointer-events-none ${side === 'right' ? '-right-16' : '-left-16'}`}>
                            Nose
                            <span className="block text-center text-lg leading-3">{side === 'right' ? '‚Üê' : '‚Üí'}</span>
                        </div>
                    )}
                    
                    {/* Eyeball Container */}
                    <div className="w-24 h-24 bg-white rounded-full shadow-[inset_-2px_-2px_6px_rgba(0,0,0,0.1)] border border-slate-200 overflow-hidden relative flex items-center justify-center">
                        {/* Texture */}
                        <div className="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48cGF0aCBkPSJNMTAgMTBRMjAgNDAgNDAgMTB6IiBzdHJva2U9InJlZCIgZmlsbD0ibm9uZSIvPjwvc3ZnPg==')] bg-cover"></div>
                        
                        {/* 3D Pivot */}
                        <div className="w-full h-full absolute inset-0 preserve-3d transition-transform duration-500 ease-out"
                             style={{ transform: `rotateX(${rotation.x}deg) rotateY(${rotation.y}deg)` }}>
                            {/* Iris */}
                            <div className="absolute top-1/2 left-1/2 w-12 h-12 -ml-6 -mt-6 rounded-full bg-gradient-to-br from-blue-500 to-indigo-700 border border-blue-800 shadow-sm flex items-center justify-center backface-hidden"
                                 style={{ transform: `translateZ(42px)` }}>
                                <div className="w-5 h-5 bg-black rounded-full shadow-inner relative">
                                    <div className="absolute top-1 right-1.5 w-1.5 h-1.5 bg-white rounded-full opacity-90 filter blur-[0.5px]"></div>
                                </div>
                            </div>
                        </div>
                        {/* Glare */}
                        <div className="absolute inset-0 rounded-full bg-gradient-to-tr from-transparent via-transparent to-white/40 pointer-events-none"></div>
                    </div>
                    {/* Eyelid Shadow */}
                    <div className="absolute -top-1 w-28 h-8 bg-gradient-to-b from-slate-200 to-transparent rounded-[50%] opacity-20 pointer-events-none"></div>
                </div>
            );
        };

        // 2. Card Component
        const Card = ({ card, muscleInfo, eyeSide, onClick }) => {
            return (
                <div className="relative w-full perspective-1000 cursor-pointer group" onClick={() => !card.isFlipped && !card.isMatched && onClick(card)}>
                    <div className="pt-[100%]"></div>
                    <div className={`absolute inset-0 transform-style-3d transition-all duration-500 shadow-md rounded-xl ${card.isFlipped ? 'rotate-y-180' : ''}`}>
                        {/* Back */}
                        <div className="absolute inset-0 backface-hidden bg-gradient-to-br from-slate-700 to-slate-900 rounded-xl border-2 border-slate-600 flex items-center justify-center">
                            <span className="text-2xl text-slate-500 opacity-20 font-bold">?</span>
                        </div>
                        {/* Front */}
                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-white rounded-xl border-2 border-indigo-100 flex flex-col items-center justify-center p-2 shadow-lg overflow-hidden">
                            {card.isMatched && <div className="absolute inset-0 bg-green-500/10 z-10"></div>}
                            {card.type === 'text' ? (
                                <div className="text-center">
                                    <span className="block text-xl sm:text-2xl font-bold text-slate-800 mb-1">{muscleInfo.id}</span>
                                    <span className="text-[10px] sm:text-xs text-slate-500 font-medium uppercase tracking-wider">{muscleInfo.name}</span>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center">
                                    <EyeGraphic side={eyeSide} muscleId={muscleInfo.id} scale={0.6} showNoseLabel={false} />
                                    <div className="mt-1 text-[9px] text-indigo-600 font-bold bg-indigo-50 px-2 py-0.5 rounded-full">Action</div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // 3. LearnView Component
        const LearnView = () => {
            const [gaze, setGaze] = useState({ x: 0, y: 0 });
            const [activeDirectionLabel, setActiveDirectionLabel] = useState("Primary Position");

            // LOGIC NOTE: 
            // x=1 -> Screen Right (Viewer Right) -> Patient's Left (Levoversion)
            // x=-1 -> Screen Left (Viewer Left) -> Patient's Right (Dextroversion)
            // y=-1 -> Up, y=1 -> Down
            const getActiveMuscles = (x, y) => {
                if (x === 0 && y === 0) return { od: "None", os: "None" };
                
                // Horizontal
                if (x === 1 && y === 0) return { od: "Medial Rectus", os: "Lateral Rectus" }; // Levoversion
                if (x === -1 && y === 0) return { od: "Lateral Rectus", os: "Medial Rectus" }; // Dextroversion
                
                // Vertical
                if (x === 0 && y === -1) return { od: "Sup. Rectus / Inf. Oblique", os: "Sup. Rectus / Inf. Oblique" };
                if (x === 0 && y === 1) return { od: "Inf. Rectus / Sup. Oblique", os: "Inf. Rectus / Sup. Oblique" };

                // Oblique / Corners (Interchanged per user request)
                // Screen Up-Right (Patient Levoelevation): Usually OD=IO, OS=SR. User wants swap:
                if (x === 1 && y === -1) return { od: "Superior Rectus", os: "Inferior Oblique" }; 

                // Screen Up-Left (Patient Dextroelevation): Usually OD=SR, OS=IO. User wants swap:
                if (x === -1 && y === -1) return { od: "Inferior Oblique", os: "Superior Rectus" }; 

                // Screen Down-Right (Patient Levodepression): Usually OD=SO, OS=IR. User wants swap:
                if (x === 1 && y === 1) return { od: "Inferior Rectus", os: "Superior Oblique" }; 

                // Screen Down-Left (Patient Dextrodepression): Usually OD=IR, OS=SO. User wants swap:
                if (x === -1 && y === 1) return { od: "Superior Oblique", os: "Inferior Rectus" }; 

                return { od: "-", os: "-" };
            };

            const handleGaze = (x, y, label) => {
                setGaze({ x, y });
                setActiveDirectionLabel(label);
            };

            const activeMuscles = getActiveMuscles(gaze.x, gaze.y);

            return (
                <div className="max-w-6xl mx-auto p-4 sm:p-6 space-y-8 animate-fade-in pb-20">
                    {/* Lecture Section */}
                    <section className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="bg-indigo-600 p-6">
                            <h2 className="text-2xl font-bold text-white flex items-center gap-2">
                                <span className="text-3xl">üëÅÔ∏è</span> Ocular Motor Systems
                            </h2>
                            <p className="text-indigo-100 mt-1">Essential Anatomy & Physiology (Chapter 17)</p>
                        </div>
                        
                        <div className="p-6 sm:p-8 text-slate-600 leading-relaxed">
                            <div className="mb-8">
                                <h3 className="text-lg font-bold text-slate-800 mb-3">Six Systems, Two Goals</h3>
                                <p className="mb-4">The control of eye movements is divided into <strong>six systems</strong>. Despite their complexity, they all share two simple goals:</p>
                                <div className="grid sm:grid-cols-2 gap-4">
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                        <span className="block font-bold text-indigo-700 mb-1">1. Foveation (Fixation)</span>
                                        To catch an image on the fovea (center of vision). Used by the <strong>Saccadic</strong>, <strong>Fixation</strong>, and <strong>Vergence</strong> systems.
                                    </div>
                                    <div className="bg-slate-50 p-4 rounded-lg border border-slate-100">
                                        <span className="block font-bold text-indigo-700 mb-1">2. Image Stabilization</span>
                                        To prevent image slip when the head moves. Used by the <strong>Vestibulo-ocular</strong>, <strong>Optokinetic</strong>, and <strong>Smooth Pursuit</strong> systems.
                                    </div>
                                </div>
                            </div>

                            <hr className="my-6 border-slate-100"/>

                            <div className="grid md:grid-cols-2 gap-12">
                                <div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-3">Controlling Simultaneous Rotation</h3>
                                    <p className="mb-4">When an object moves, or when our head moves, our eyes must rotate together to keep the object seen clearly. There are two mechanisms for this:</p>
                                    <div className="space-y-3">
                                        <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <span className="block font-bold text-slate-800 text-sm">Conjugate Movements (Versions)</span>
                                            <p className="text-xs mt-1">When an object moves horizontally, vertically, or obliquely in a frontal plane, both eyes must move <strong>simultaneously in the same direction</strong>.</p>
                                        </div>
                                        <div className="bg-slate-50 p-3 rounded border border-slate-200">
                                            <span className="block font-bold text-slate-800 text-sm">Disjunctive Movements (Vergence)</span>
                                            <p className="text-xs mt-1">When an object moves toward or away from the viewer, the eyes must move in <strong>opposite directions</strong> (converging or diverging).</p>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-lg font-bold text-slate-800 mb-3">Laws of Coordination</h3>
                                    <p className="mb-4">Hering and Helmholtz debated how eyes move together. Hering believed they receive the same signals simultaneously.</p>
                                    <div className="space-y-3">
                                        <div className="bg-blue-50 p-3 rounded border border-blue-100">
                                            <h4 className="font-bold text-blue-900 text-sm">Hering's Law (Equal Innervation)</h4>
                                            <p className="text-xs text-blue-800 mt-1">Yoked muscles (pulling in the same direction) receive equal innervation. <br/><em>Ex: Looking right stimulates Right Lateral Rectus & Left Medial Rectus equally.</em></p>
                                        </div>
                                        <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                            <h4 className="font-bold text-purple-900 text-sm">Sherrington's Law (Reciprocal)</h4>
                                            <p className="text-xs text-purple-800 mt-1">When an agonist contracts, its antagonist relaxes. <br/><em>Ex: Medial Rectus contracts -> Lateral Rectus inhibits.</em></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    {/* Simulator Section */}
                    <section className="grid lg:grid-cols-3 gap-6">
                        {/* Controls */}
                        <div className="lg:col-span-1 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 flex flex-col items-center justify-center">
                            <h3 className="text-lg font-bold text-slate-700 mb-6 uppercase tracking-wider">Binocular Simulator</h3>
                            <p className="text-xs text-slate-400 mb-4 text-center">Click arrows to move eyes</p>
                            
                            <div className="grid grid-cols-3 gap-2 p-4 bg-slate-50 rounded-full shadow-inner border border-slate-200 mb-6">
                                <button onClick={() => handleGaze(-1, -1, "Up-Left Gaze")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üñ</button>
                                <button onClick={() => handleGaze(0, -1, "Elevation")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üë</button>
                                <button onClick={() => handleGaze(1, -1, "Up-Right Gaze")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üó</button>
                                
                                <button onClick={() => handleGaze(-1, 0, "Dextroversion")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üê</button>
                                <button onClick={() => handleGaze(0, 0, "Primary")} className="w-12 h-12 rounded-full bg-blue-600 shadow-md border border-blue-700 flex items-center justify-center text-white font-bold transition-all transform active:scale-95 text-xl">‚óè</button>
                                <button onClick={() => handleGaze(1, 0, "Levoversion")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üí</button>
                                
                                <button onClick={() => handleGaze(-1, 1, "Down-Left Gaze")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üô</button>
                                <button onClick={() => handleGaze(0, 1, "Depression")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üì</button>
                                <button onClick={() => handleGaze(1, 1, "Down-Right Gaze")} className="w-12 h-12 rounded-full bg-white shadow-sm hover:bg-blue-50 border border-slate-200 flex items-center justify-center text-xl hover:text-blue-600 transition-all">‚Üò</button>
                            </div>
                            
                            <div className="text-center w-full">
                                <div className="text-xs text-slate-400 uppercase tracking-widest font-semibold mb-1">Current Action</div>
                                <div className="text-xl font-bold text-blue-600 truncate">{activeDirectionLabel}</div>
                            </div>
                        </div>

                        {/* Display */}
                        <div className="lg:col-span-2 bg-slate-900 rounded-2xl shadow-xl overflow-hidden relative flex flex-col">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-indigo-500 to-purple-500"></div>
                            
                            <div className="flex-1 min-h-[300px] flex flex-col items-center justify-center bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-800 to-slate-900">
                                <div className="flex items-center justify-center gap-4 sm:gap-8 perspective-1000">
                                    {/* Right Eye (OD) */}
                                    <div className="flex flex-col items-center gap-4">
                                        <EyeGraphic side="right" gaze={gaze} scale={1.2} showNoseLabel={false} />
                                        <span className="text-white/50 text-sm font-mono tracking-widest">OD (Right)</span>
                                    </div>
                                    {/* Nose */}
                                    <div className="flex flex-col items-center justify-center h-24">
                                        <div className="w-1 h-12 bg-slate-700 rounded-full mb-1"></div>
                                        <div className="text-xs font-bold text-slate-500 uppercase tracking-widest">Nose</div>
                                        <div className="w-8 h-20 border-t-4 border-l-4 border-r-4 border-slate-700/50 rounded-t-3xl mt-2"></div>
                                    </div>
                                    {/* Left Eye (OS) */}
                                    <div className="flex flex-col items-center gap-4">
                                        <EyeGraphic side="left" gaze={gaze} scale={1.2} showNoseLabel={false} />
                                        <span className="text-white/50 text-sm font-mono tracking-widest">OS (Left)</span>
                                    </div>
                                </div>
                            </div>

                            {/* Data Bar */}
                            <div className="bg-slate-800 p-4 border-t border-slate-700">
                                <h4 className="text-xs text-slate-400 uppercase font-bold mb-3 flex items-center gap-2">
                                    <span className="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                                    Primary Agonist Muscles (Hering's Law Pairs)
                                </h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                                        <span className="text-xs text-slate-400 block mb-1">Right Eye (OD)</span>
                                        <span className="text-green-300 font-semibold">{activeMuscles.od}</span>
                                    </div>
                                    <div className="bg-slate-700/50 p-3 rounded-lg border border-slate-600">
                                        <span className="text-xs text-slate-400 block mb-1">Left Eye (OS)</span>
                                        <span className="text-green-300 font-semibold">{activeMuscles.os}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            );
        };

        // 4. GameView Component
        const GameView = () => {
            const [gameState, setGameState] = useState({ isPlaying: false, gameWon: false, currentEye: 'right', moves: 0, timer: 0 });
            const [cards, setCards] = useState([]);
            const [choiceOne, setChoiceOne] = useState(null);
            const [choiceTwo, setChoiceTwo] = useState(null);
            const [disabled, setDisabled] = useState(false);

            const shuffleCards = useCallback(() => {
                const randomEye = Math.random() > 0.5 ? 'right' : 'left';
                const visualCards = MUSCLES.map(m => ({ uniqueId: `v-${m.id}`, muscleId: m.id, type: 'visual', isFlipped: false, isMatched: false }));
                const textCards = MUSCLES.map(m => ({ uniqueId: `t-${m.id}`, muscleId: m.id, type: 'text', isFlipped: false, isMatched: false }));
                
                const allCards = [...visualCards, ...textCards].sort(() => Math.random() - 0.5);
                setCards(allCards);
                setGameState({ isPlaying: true, gameWon: false, currentEye: randomEye, moves: 0, timer: 0 });
                setChoiceOne(null);
                setChoiceTwo(null);
                setDisabled(false);
            }, []);

            const handleChoice = (card) => {
                if (disabled) return;
                choiceOne ? setChoiceTwo(card) : setChoiceOne(card);
            };

            useEffect(() => {
                if (choiceOne && choiceTwo) {
                    setDisabled(true);
                    if (choiceOne.muscleId === choiceTwo.muscleId) {
                        setCards(prev => prev.map(card => card.muscleId === choiceOne.muscleId ? { ...card, isMatched: true, isFlipped: true } : card));
                        resetTurn();
                    } else {
                        setTimeout(resetTurn, 1000);
                    }
                }
            }, [choiceOne, choiceTwo]);

            const resetTurn = () => {
                setChoiceOne(null);
                setChoiceTwo(null);
                setCards(prev => prev.map(card => {
                    if (!card.isMatched && (card.uniqueId === choiceOne?.uniqueId || card.uniqueId === choiceTwo?.uniqueId)) {
                        return { ...card, isFlipped: false };
                    }
                    return card;
                }));
                setGameState(prev => ({ ...prev, moves: prev.moves + 1 }));
                setDisabled(false);
            };

            useEffect(() => {
                if (choiceOne) setCards(prev => prev.map(c => c.uniqueId === choiceOne.uniqueId ? { ...c, isFlipped: true } : c));
                if (choiceTwo) setCards(prev => prev.map(c => c.uniqueId === choiceTwo.uniqueId ? { ...c, isFlipped: true } : c));
            }, [choiceOne, choiceTwo]);

            useEffect(() => {
                let interval;
                if (gameState.isPlaying && !gameState.gameWon) {
                    interval = setInterval(() => setGameState(p => ({ ...p, timer: p.timer + 1 })), 1000);
                }
                return () => clearInterval(interval);
            }, [gameState.isPlaying, gameState.gameWon]);

            useEffect(() => {
                if (cards.length > 0 && cards.every(c => c.isMatched)) setGameState(p => ({ ...p, gameWon: true }));
            }, [cards]);

            const formatTime = (s) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, '0')}`;

            if (!gameState.isPlaying) {
                return (
                    <div className="flex flex-col items-center justify-center py-12 px-4 animate-fade-in">
                        <div className="max-w-2xl w-full bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-200">
                            <div className="bg-indigo-600 p-8 text-center">
                                <h1 className="text-4xl font-bold text-white mb-2">Know Your EOM</h1>
                                <p className="text-indigo-200 text-lg">Memory Flip Card Game</p>
                            </div>
                            <div className="p-8 space-y-6">
                                <p className="text-slate-600 whitespace-pre-line text-sm">{INTRO_TEXT}</p>
                                <button onClick={shuffleCards} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-lg font-semibold py-4 rounded-xl shadow-lg transition-transform hover:scale-[1.02] active:scale-[0.98]">Start Game</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full animate-fade-in">
                    {/* Status Bar */}
                    <div className="bg-white shadow-sm border-b border-slate-200 p-4 sticky top-0 z-20">
                        <div className="max-w-6xl mx-auto flex items-center justify-between">
                            <h2 className="text-lg font-bold text-slate-700 hidden sm:block">Test Mode</h2>
                            <div className="flex items-center gap-6 text-sm font-medium text-slate-600">
                                <div className="flex flex-col items-center"><span className="text-xs text-slate-400">Moves</span><span className="text-lg text-slate-800">{gameState.moves}</span></div>
                                <div className="flex flex-col items-center"><span className="text-xs text-slate-400">Time</span><span className="text-lg text-slate-800">{formatTime(gameState.timer)}</span></div>
                            </div>
                            <button onClick={shuffleCards} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-xs font-bold uppercase tracking-wider">Restart</button>
                        </div>
                    </div>

                    <div className="flex-1 max-w-6xl mx-auto w-full p-4 flex flex-col md:flex-row gap-6">
                        {/* Sidebar */}
                        <aside className="md:w-64 shrink-0 space-y-4">
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 overflow-hidden relative">
                                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-indigo-600"></div>
                                <h2 className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Patient</h2>
                                <div className="flex flex-col items-center py-2">
                                    <div className="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mb-2 relative border-4 border-white shadow-sm">
                                        <EyeGraphic side={gameState.currentEye} scale={1.0} />
                                    </div>
                                    <div className="text-lg font-bold text-slate-800">{gameState.currentEye === 'right' ? 'Right Eye (OD)' : 'Left Eye (OS)'}</div>
                                </div>
                                <div className="mt-2 p-3 bg-blue-50 rounded-lg border border-blue-100 text-[11px] text-blue-800 leading-snug">
                                    Nose is on the <span className="font-bold">{gameState.currentEye === 'right' ? 'LEFT' : 'RIGHT'}</span> side.
                                </div>
                            </div>
                        </aside>

                        {/* Grid */}
                        <section className="flex-1">
                            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3 sm:gap-4 w-full mx-auto">
                                {cards.map(card => (
                                    <Card key={card.uniqueId} card={card} muscleInfo={MUSCLES.find(m => m.id === card.muscleId)} eyeSide={gameState.currentEye} onClick={handleChoice} />
                                ))}
                            </div>
                        </section>
                    </div>

                    {/* Win Modal */}
                    {gameState.gameWon && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full p-8 text-center animate-fade-in">
                                <div className="inline-flex items-center justify-center w-16 h-16 bg-green-100 text-green-600 rounded-full mb-4">‚úì</div>
                                <h2 className="text-3xl font-bold text-slate-800 mb-2">Excellent!</h2>
                                <p className="text-slate-600 mb-6">Completed in {formatTime(gameState.timer)} with {gameState.moves} moves.</p>
                                <button onClick={shuffleCards} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg">Next Patient</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. Main App Component
        const App = () => {
            const [activeTab, setActiveTab] = useState('learn');

            return (
                <div className="min-h-screen bg-slate-50 flex flex-col font-sans">
                    <header className="bg-white shadow-md border-b border-slate-200 sticky top-0 z-30">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">E</div>
                                <span className="text-slate-800 font-bold text-xl tracking-tight hidden sm:block">Know Your EOM</span>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl">
                                <button onClick={() => setActiveTab('learn')} className={`px-5 py-2 rounded-lg text-sm font-semibold transition-all ${activeTab === 'learn' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Learn</button>
                                <button onClick={() => setActiveTab('test')} className={`px-5 py-2 rounded-lg text-sm font-semibold transition-all ${activeTab === 'test' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>Test</button>
                            </div>
                        </div>
                    </header>
                    <main className="flex-1 w-full relative">
                        {activeTab === 'learn' ? <LearnView /> : <GameView />}
                    </main>
                    <footer className="bg-slate-100 border-t border-slate-200 py-6 text-center text-slate-400 text-sm">
                        <p>¬© {new Date().getFullYear()} EOM Educational Tool</p>
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>